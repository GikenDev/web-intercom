<!DOCTYPE html>
<html>
  <head>
    <meta charset="UTF-8">
    <script src="../../static/packet_conv/audio.js"></script>
    <script>
      /**
       * Tests for `packet_conv/audio.js`
       *
       * Test cases:
       *   * Can encode/decode audio packet with[out] custom bytes
       *   * Throw TypeError if invalid argument is passed
       *   * Throw RangeError if invalid argument is passed
       *
       * Test steps:
       *   1. Open this HTML with browser
       *   2. Open JavaScript console
       *   3. Click test buttons
       *   4. Check console output
       *
       * @author aKuad
       */

      /**
       * Error in type conversion between int16n and float32
       */
      ERR_INT16_AND_FLOAT32 = 1 / 32767;


      function test_all() {
        test_true_enc_dec_ext();
        test_true_enc_dec_noext();
        test_err_enc_invalid_type();
        test_err_enc_invalid_value();
        test_err_dec_invalid_type();
        test_err_dec_invalid_value();
      }


      function test_true_enc_dec_ext() {
        console.log("-- test_packet_enc_dec_with_ext");
        const audio_pcm_org = part_testdata_rand_int16array();
        const lane_name_org = "ABC";
        const ext_bytes_org = new Uint8Array([1,2,3,4]);
        const raw_packet = packet_audio_encode(audio_pcm_org, lane_name_org, ext_bytes_org);
        const [audio_pcm_prc, lane_name_prc, ext_bytes_prc] = packet_audio_decode(raw_packet);

        if(part_is_equal_f32a(audio_pcm_org, audio_pcm_prc, ERR_INT16_AND_FLOAT32) &&
           lane_name_org === lane_name_prc &&
           ext_bytes_org.join() === ext_bytes_prc.join()) {
          console.log("--- OK");
        } else {
          console.log("--- NG - Original data and decoded data is different");
          console.log("Audio PCM - Expected:", audio_pcm_org);
          console.log("            Actual  :", audio_pcm_prc);
          console.log("Lane name - Expected:", lane_name_org);
          console.log("            Actual  :", lane_name_prc);
          console.log("Ext bytes - Expected:", ext_bytes_org);
          console.log("            Actual  :", ext_bytes_prc);
        }
      }


      function test_true_enc_dec_noext() {
        console.log("-- test_packet_enc_dec_without_ext");
        const audio_pcm_org = part_testdata_rand_int16array();
        const lane_name_org = "ABC";
        const raw_packet = packet_audio_encode(audio_pcm_org, lane_name_org);
        const [audio_pcm_prc, lane_name_prc, ext_bytes_prc] = packet_audio_decode(raw_packet);

        if(part_is_equal_f32a(audio_pcm_org, audio_pcm_prc, ERR_INT16_AND_FLOAT32) &&
           lane_name_org === lane_name_prc &&
           ext_bytes_prc.length === 0) {
          console.log("--- OK");
        } else {
          console.log("--- NG - Original data and decoded data is different");
          console.log("Audio PCM - Expected:", audio_pcm_org);
          console.log("            Actual  :", audio_pcm_prc);
          console.log("Lane name - Expected:", lane_name_org);
          console.log("            Actual  :", lane_name_prc);
          console.log("Ext len   - Expected:", 0);
          console.log("            Actual  :", ext_bytes_prc.length);
        }
      }


      function test_err_enc_invalid_type() {
        console.log("-- test_err_enc_invalid_type");
        const audio_pcm = part_testdata_rand_int16array();
        const lane_name = "ABC";
        const ext_bytes = new Uint8Array([1,2,3]);

        try {
          packet_audio_encode("", lane_name, ext_bytes);  // string "" as non Float32Array
          console.log("--- NG - Error hasn't throned");
        } catch(e) {
          if(e.toString() === "TypeError: audio_pcm must be Float32Array") {
            console.log("--- OK");
          } else {
            console.log(e);
            console.log("--- NG - Un expected error throned");
          }
        }

        try {
          packet_audio_encode(audio_pcm, 1, ext_bytes); // number 1 as non string
          console.log("--- NG - Error hasn't throned");
        } catch(e) {
          if(e.toString() === "TypeError: lane_name must be string") {
            console.log("--- OK");
          } else {
            console.log(e);
            console.log("--- NG - Un expected error throned");
          }
        }

        try {
          packet_audio_encode(audio_pcm, lane_name, "");  // string "" as non Uint8Array
          console.log("--- NG - Error hasn't throned");
        } catch(e) {
          if(e.toString() === "TypeError: ext_bytes must be Uint8Array") {
            console.log("--- OK");
          } else {
            console.log(e);
            console.log("--- NG - Un expected error throned");
          }
        }
      }


      function test_err_enc_invalid_value() {
        console.log("-- test_err_enc_invalid_value");
        const audio_pcm = part_testdata_rand_int16array();
        const lane_name = "ABC";
        const ext_bytes = new Uint8Array([1,2,3]);

        const lane_name_non_ascii = "ðŸ—’";
        const lane_name_over_len = "ABCD";
        const ext_bytes_over_len = new Uint8Array(256);

        try {
          packet_audio_encode(audio_pcm, lane_name_non_ascii, ext_bytes);
          console.log("--- NG - Error hasn't throned");
        } catch(e) {
          if(e.toString() === "RangeError: For lane_name, non ascii characters are not allowed") {
            console.log("--- OK");
          } else {
            console.log(e);
            console.log("--- NG - Un expected error throned");
          }
        }

        try {
          packet_audio_encode(audio_pcm, lane_name_over_len, ext_bytes);
          console.log("--- NG - Error hasn't throned");
        } catch(e) {
          if(e.toString() === "RangeError: For lane_name, over 3 characters string is not allowed") {
            console.log("--- OK");
          } else {
            console.log(e);
            console.log("--- NG - Un expected error throned");
          }
        }

        try {
          packet_audio_encode(audio_pcm, lane_name, ext_bytes_over_len);
          console.log("--- NG - Error hasn't throned");
        } catch(e) {
          if(e.toString() === "RangeError: For ext_bytes, over 255 bytes data is not allowed") {
            console.log("--- OK");
          } else {
            console.log(e);
            console.log("--- NG - Un expected error throned");
          }
        }
      }


      function test_err_dec_invalid_type() {
        console.log("-- test_err_dec_invalid_type");

        try {
          packet_audio_decode("");  // string "" as non Uint8Array
          console.log("--- NG - Error hasn't throned");
        } catch(e) {
          if(e.toString() === "TypeError: raw_packet must be Uint8Array") {
            console.log("--- OK");
          } else {
            console.log(e);
            console.log("--- NG - Un expected error throned");
          }
        }
      }


      function test_err_dec_invalid_value() {
        console.log("-- test_err_dec_invalid_value");
        const raw_packet_invalid_id = Uint8Array.of(0x11, 0x41, 0x42, 0x43, 0x00, ...part_testdata_rand_int16array());
        //                                          ~~~~  ~~~~~~~~~~~~~~~~
        //                                           |     as string "ABC"
        //                                          as non 0x10 byte
        const raw_packet_invalid_len = Uint8Array.of(0x10, 0x41, 0x42, 0x43);
        // ext_bytes data missing packet

        try {
          packet_audio_decode(raw_packet_invalid_id);
          console.log("--- NG - Error hasn't throned");
        } catch(e) {
          if(e.toString() === "RangeError: Invalid packet ID, it is not an audio packet") {
            console.log("--- OK");
          } else {
            console.log(e);
            console.log("--- NG - Un expected error throned");
          }
        }

        try {
          packet_audio_decode(raw_packet_invalid_len);
          console.log("--- NG - Error hasn't throned");
        } catch(e) {
          if(e.toString() === "RangeError: Invalid packet, too short bytes received") {
            console.log("--- OK");
          } else {
            console.log(e);
            console.log("--- NG - Un expected error throned");
          }
        }
      }


      function part_testdata_rand_int16array() {
        return Float32Array.from(new Array(4410), e => (Math.random() - 0.5) * 2);
        // - 0.5   --> Random number range is [ -0.5, 0.5)
        // * 2     -->                        [   -1,   1)
      }


      /**
       * @param {Float32Array} array1 Array to compare
       * @param {Float32Array} array2 Array to compare
       * @param {number} allow_diff Value difference to allow
       * @return {boolean} Equal: true, Otherwise: false
       */
      function part_is_equal_f32a(array1, array2, allow_diff) {
        if(array1.length != array2.length) { return false; }

        for(let i = 0; i < array1.length; i++) {
          if(Math.abs(array1[i] - array2[i]) > allow_diff) { return false; }
        }
        return true;
      }
    </script>
  </head>

  <body>
    <button onclick="test_all()">Run all tests</button>
  </body>
</html>
